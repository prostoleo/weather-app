<template>
  <section class="pb-8">
    <BaseContainer>
      <BaseSpinner v-if="loading" />
      <div v-else-if="!loading && !getData"   class="error pt-5 text-center text-white text-lg">
        –£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòû. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.
      </div>
      <div v-else class="content">
        <div class="upper-content text-center text-white pt-6">
          <h3 class="date text-sm opacity-80 uppercase">
            {{ compShortDateTime?.date }}
          </h3>
          <h3 class="time mt-1  text-sm opacity-80">
            {{ compShortDateTime?.time }}
          </h3>
          <h2 class="l–æcation mt-3 ">
            {{ getData.name }}, {{ getCountryName }}
          </h2>
          <h2 class="temperature mt-4 text-4xl  font-bold">
            {{ Math.round(getData.main.temp) }}
          </h2>

          <h3 class="description mt-2">
            {{ getData.weather[0].description }}
          </h3>

          <img :src="`http://openweathermap.org/img/w/${getData.weather[0].icon}.png`" alt="–æ–±–ª–∞—á–Ω–æ —Å –ø—Ä–æ—è—Å–Ω–µ–Ω–∏—è–º–∏" class="description-img mx-auto mt-3 w-10">

          <div class="main-card mt-5 p-6 pb-7 w-max mx-auto bg-white rounded-3xl text-black flex justify-center gap-x-3 relative">

            <div class="col flex flex-col items-center justify-between">
              <img src="/icons/min.svg" alt="" class="icon w-5 h-5">
              <span class="value block font-bold">{{  Math.round(getData.main.temp_min) }}</span>
              <span class="naming block">–º–∏–Ω</span>  
            </div>

            <div class="col flex flex-col items-center justify-between gap-y-1">
              <img src="/icons/max.svg" alt="" class="icon w-5 h-5">
              <span class="value block font-bold">{{ Math.round(getData.main.temp_max) }}</span>
              <span class="naming block">–º–∞–∫—Å</span>  
            </div>

            <div class="col flex flex-col items-center justify-between gap-y-1">
              <img src="/icons/humidity.svg" alt="" class="icon w-5 h-5">
              <span class="value block font-bold">{{ getData.main.humidity }}%</span>
              <span class="naming block">–≤–ª–∞–∂</span>  
            </div>

            <div class="col flex flex-col items-center justify-between gap-y-1">
              <img src="/icons/clouds.svg" alt="" class="icon w-5 h-5 opacity-50">
              <span class="value block font-bold">{{ getData.wind.speed.toFixed(1) }} –º/—Å</span>
              <span class="naming block">{{ getData.wind.deg }}</span>  
            </div>

            <router-link to="/details" class="bg-green-500 bg-accent rounded-2xl py-2 px-3 leading-none text-dark-900 text-sm inline-flex items-center justify-center align-baseline absolute top-full left-2/4 transform -translate-x-6/12 -translate-y-6/12">
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </router-link>
          </div>  
        </div>

        <div class="days-wrapper mt-14">
          <h2 class="title font-bold text-white ">
            <router-link to="/days" class="text-white py-1 border-b-1 border-b-accent border-opacity-0 transition-all duration-150 hover:!border-opacity-100">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</router-link>
          </h2>

          <div class="cards__wrapper mt-5 flex gap-x-3 items-center overflow-x-auto">
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            <div class="card px-6 py-3 bg-white rounded-3xl flex flex-col items-center gap-y-1">
              <span class="day uppercase text-sm">—Å–±</span>
              <img src="/icons/clouds.svg" alt="" class="w-5 h-5">
              <span class="temperature font-bold">+7</span>
            </div>
            
          </div>
        </div>

        <!-- <pre class="text-gray-50 ">
          {{ data }}
        </pre> -->
      
      </div>
      
    </BaseContainer>
  </section>
</template>

<script setup lang="ts">
// todo  –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
import { WEATHER_URL, API_KEY, TIME } from '~/config/config.js';

// todo –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ—É –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
import { getCountryByCode } from '~/data/data.js';

import { useWeatherNowStore } from '~/stores/weather.js'

console.log('WEATHER_URL: ', WEATHER_URL);
console.log('API_KEY: ', API_KEY);
console.log('TIME: ', TIME);

//* –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
const data = ref(null);
//* –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
const loading = ref(false);

const locale = navigator.language;

// todo –ø–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≥–æ–¥–µ
async function getWeatherData() {
  try {
    loading.value = true;

    const response = await fetch(`${WEATHER_URL}?q=–ß–µ–ª—è–±–∏–Ω—Å–∫&units=metric&appid=${API_KEY}&lang=ru`);
    console.log('response: ', response);

    if (!response.ok) {
      throw new Error('–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ ');
    }

    const result = await response.json();
    console.log('result: ', result);

    data.value = result;

    
    // return result;
  } catch (error) {
    console.log(`üí£üí£üí£ ${error}`);
  } finally {
    loading.value = false;
  }
};

//* –Ω–∞–±–ª—é–¥–∞–µ–º –∑–∞ —Ñ—É–Ω–∫—Ü–∏–µ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
watch(getWeatherData, (newVal) => {
  console.log('newVal: ', newVal);
  // data.value = await newVal;
});

const getData = computed(() => data.value);

// todo —Ä–∞–±–æ—Ç–∞ —Å pinia store
const weatherNow = useWeatherNowStore();
weatherNow.addWeatherNow(getData.value);

//=====================================

//* computed –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –≤ –∫–æ—Ä–æ—Ç–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
const compShortDateTime = computed(() => {
  console.log('getData.value: ', getData.value);
  if (getData.value) {
    console.log('getData.value?.dt: ', getData.value?.dt);
    console.log('getData.value?.dt: ', typeof getData.value?.dt);
    console.log('getData.value?.timezone: ', getData.value?.timezone);
    console.log('getData.value?.timezone: ', typeof getData.value?.timezone);

    //* –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –¥–∞—Ç—É –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É timestamp
    const realDate = getLocalDate(getData.value?.timezone);

    const date = Intl.DateTimeFormat(locale, {
      weekday: 'short',
      day: 'numeric',
      month: 'short'
    }).format(realDate);

    const time = Intl.DateTimeFormat(locale, {
      hour: '2-digit',
      minute: '2-digit'
    }).format(realDate);

    return {
      date,
      time 
    }
    // return getData.value.dt;
  }
});

// todo –ø–æ–ª—É—á–∞–µ–º –∏–º—è —Å—Ç—Ä–∞–Ω—ã
const getCountryName = computed(() => {
  return getCountryByCode(getData.value?.sys.country)
})

// todo —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∞—Ç—É –ø–æ –º–µ—Å—Ç—É
const getLocalDate = (timezone) => {
  const d = new Date();
  console.log('d: ', d);

  //* –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const localTime = d.getTime();
  console.log('localTime: ', localTime);

  //* –ø–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É –≤ –º–∏–Ω—É—Ç–∞—Ö –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ–µ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
  const localOffset = d.getTimezoneOffset() * 60 * 1000;
  console.log('d.getTimezoneOffset(): ', d.getTimezoneOffset());
  console.log('localOffset: ', localOffset);

  //* –ø–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ –≥—Ä–∏–Ω–≤–∏—á—É
  const utc = localTime + localOffset;
  console.log('utc: ', utc);

  //* –ø–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π timestamp —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º 
  const localDate = utc + (1000 * timezone);

  //* –ø–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞—Ç—ã
  const realDate = new Date(localDate);
  console.log('realDate: ', realDate);

  return realDate;
}

// const data = await getWeatherData();
</script>

<style lang="scss" scoped>
@use '../styles/main.scss' as *;

section {
  // background: url("/public/img/bg/bg-main.jpg");
  background: url(https://images.unsplash.com/photo-1543699936-c901ddbf0c05?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80) $black40;
  background-blend-mode: overlay;
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
}

// .upper-content {
//   padding-top: 2.5rem;

//   text-align: center;

//   h3.date {
//     font-size: 1rem;
//     font-weight: 400;
//     color: $white80;

//     margin-bottom: 0.5em;
//     text-transform: uppercase;
//   }

//   h3.time {
//     font-size: 1rem;
//     font-weight: 400;
//     color: $white80;

//     margin-bottom: 2.5em;
//     text-transform: uppercase;
//   }

//   h2.l–æcation {
//     font-size: 1.4rem;
//     font-weight: 400;
//     color: $white;

//     margin-bottom: 2.5em;
//   }

//   h2.temperature {
//     font-size: 3.6rem;
//     font-weight: 700;
//     color: $white;

//     margin-bottom: 0.5em;
//   }

//   h3.description {
//     font-size: 1.2rem;
//     font-weight: 400;
//     color: $white;

//     margin-bottom: 1em;
//   }

//   img.description-img {
//     margin: 0 auto;
//   }

//   .main-card {
//     position: relative;

//     max-width: 20rem;
//     margin: 0 auto;

//     border-radius: 1.5rem;
//     padding: 1.5em;
//     padding-bottom: 2.25em;

//     display: flex;
//     justify-content: space-between;
//     align-items: center;

//     background: $white;

//     .col {
//       display: flex;
//       flex-direction: column;
//       align-items: center;
//       img.icon {
//         width: 2rem;
//       }
//       span.value {
//         font-size: 1.4rem;
//         font-weight: 700;
//         color: $black;
//       }
//       span.naming {
//         font-size: 1.2rem;
//         font-weight: 300;
//         color: $black;
//       }
//     }

//     button.details {
//       position: absolute;
//       top: 100%;
//       left: 50%;

//       transform: translate(-50%, -50%);

//       display: inline-flex;
//       align-items: center;
//       justify-content: center;

//       border-radius: 1.5rem;
//       background: $accent;


//       font-size: 1.4rem;
//       padding: 0.5em 1em;
//       line-height: 1;

//       text-align: top;
//     }
//   }
// }

// .days-wrapper {
//   h2.title {
//     a {}
//   }

//   .cards__wrapper {
//     .card {
//       span.day {}
//       img {}
//       span.temperature {}
//     }
//   }
// }

</style>

<route lang="yaml">
meta:
  layout: home
</route>